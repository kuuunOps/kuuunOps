# Docker概述

> Docker是用于开发、交付和运行应用程序的开放平台。Docker能够将应用程序与基础结构分开，以便快速交付软件。借助Docker可以与管理应用程序相同的方式管理基础结构。通过利用 Docker 快速交付、测试和部署代码的方法，可以显著减少编写代码和在生产环境中运行代码之间的延迟。

## 一、Docker平台

Docker提供了在被称为容器的松散隔离的环境中打包和运行应用程序的功能。其隔离性、安全性可以一台主机上同时运行多个容器。因为容器是轻量级的，它不会为管理程序增加额外的负担，而是直接运行在主机的内核中。与虚拟机相比，可以在同等的硬件资源运行更多的容器资源。也可以将Docker容器运行在虚拟主机上。

Docker提供了一些列工具和平台来管理容器的生命周期：

- 容器可以开发应用程序和及其支持的组件。
- 容器可以成为分发和测试应用程序的执行单元。
- 可以部署应用程序做为一个容器或一组规划的服务部署到生产环境中。

## 二、Docker引擎

Docker引擎是一个具有以下主要组件的CS架构应用程序。

- `dockerd` 服务：一种被称为守护进程可以长时间运行的命令。
- `REST API` ：指定程序使用与守护程序进行通信和指示其操作的接口。
- `docker` ：命令行客户端命令行工具。

客户端在脚本中使用 `REST API` 控制和Docker守护进程交互，或直接使用CLI命令。
Docker守护进程可以创建和管理Docker对象资源，例如管理镜像，容器，网络，以及数据卷。

![引擎组件数据流结构](../../../_media/engine-components-flow.png)

## 三、使用Docker可以做哪些事情？

**快速、一致性交付应用程序**

Docker基于容器的平台实现了高度可移植性工作。Docker容器可以在开发人员的本地笔记本电脑上，数据中心中的物理或虚拟机上，云提供商上或混合环境中运行。

Docker的可移植性和轻量级的特性还使您可以轻松地动态管理工作，并根据业务需求扩展或关闭应用程序和服务。

**在同等硬件上可以运行更多服务**

Docker轻量，快速。它为基于虚拟机管理程序的虚拟机提供了可行且经济高效的替代方案，因此可以利用更多的计算能力来实现更多业务目标。 Docker非常适合高密度环境以及中小型部署，而只需要用更少的资源做更多的事情。

## 四、Docker体系架构

Docker使用CS架构。Docker客户端通过调用Docker守护进程，由守护进程完成构建，运行和分发Docker容器的繁重工作。Docker客户端和守护程序可以在同一系统上运行，也可以将Docker客户端连接到远程Docker守护程序。Docker客户端和守护进程通过UNIX的sockets或者网络接口`REST API`来使用。

![体系架构](../../../_media/architecture.svg)

## 五、Docker守护程序

Docker守护程序（dockerd）侦听`Docker API`的请求并管理Docker对象，例如镜像，容器，网络和数据卷。守护程序还可以与其他守护程序通信以管理Docker服务。

## 六、Docker客户端

Docker客户端（docker）是许多Docker用户与Docker交互的主要方式。当您使用诸如`docker run`之类的命令时，客户端会将这些命令发送到dockerd，然后执行它们。 docker命令使用`Docker API`。Docker客户端可以与多个守护程序通信。

## 七、Docker注册中心

Docker注册中心存储Docker镜像文件。 Docker Hub是任何人都可以使用的公共注册中心，并且Docker配置为默认在Docker Hub上查找镜像文件。也可以运行自己的私人注册仓库。

使用`docker pull`或`docker run`命令时，所需的镜像文件将从配置的注册中心中拉取。使用`docker push`命令时，会将镜像文件推送到配置的注册中心。

## 八、Docker资源对象

当时用Docker时，可能会创建和使用到镜像，容器，网络,数据卷，插件，以及其他资源对象。

### 镜像文件（IMAGES）

镜像是一个只读模板，其中包含创建Docker容器的说明。通常，一个镜像基于另一个镜像而创建，并进行一些其他自定义操作。例如，您可以基于ubuntu镜像的构建镜像文件，安装Apache Web服务器和您的应用程序，以及运行应用程序所需的配置详细信息。

可以创建自己的镜像，也可以仅使用其他人创建并在注册中心已发布的镜像。要构建自己的镜像，可以使用简单的语法创建一个`Dockerfile`文件，用以定义创建镜像和运行它所需的步骤。 `Dockerfile`中的每条指令都会在镜像中创建一个层。当您更改Dockerfile并重建镜像时，仅重建那些已更改的层。与其他虚拟化技术相比，这样就使的镜像会如此轻便，小巧和快速的部分原因。

### 容器（CONTAINER）

容器是镜像运行后产生的具体实例。可以使用`Docker API`或`CLI`创建，启动，停止，移动或删除容器。也可以将容器连接到一个或多个网络，将存储介质连接到它，甚至根据其当前状态创建一个新镜像。

默认情况下，容器与其他容器及其主机之间都是相对隔离的。可以通过控制容器的网络，存储或其他基础子系统与其他容器或主机之间来调整隔离程度。

容器由其镜像以及在创建或启动时为其提供的任何配置选项，在删除容器后，如果未存储到永久性存储中，这些配置状态更改将消失。

**示例：**
通过以下命令运行ubuntu容器，并以交互方式附加到本地命令行会话重，然后运行 `/bin/bash` 。
```bash
docker run -i -t ubuntu /bin/bash
```

当您运行此命令时，会发生以下一些列情况变化：

1. 如果本地没有ubuntu镜像，则Docker会将其从默认配置的注册中心拉出，就像手动运行 `docker pull ubuntu` 一样。
2. Docker创建了一个新容器，就像手动运行 `docker container create` 命令一样。
3. Docker将一个可读写的文件系统分配给容器，作为其最后一层。这允许运行中的容器在其本地文件系统中创建或修改文件和目录。
4. Docker创建了一个网络接口，将容器连接到默认网络，因为您没有指定任何网络选项。这包括为容器分配IP地址。默认情况下，容器可以使用主机的网络连接访问到外部网络。
5. Docker启动容器后并执行 `/bin/bash` 。由于使用 `-i` 和 `-t` 的选项容器是以交互式运行的，并且附加到当前的终端，输出纪录会输出到终端，并可以通过键盘输入到终端。
6. 当您键入 `exit` 终止`/bin/bash` 命令时，该容器将停止但不会被删除掉。可以手动重新启动或删除它。

### 集群服务（SERVICES）

集群服务使您可以在多个Docker守护程序之间扩展容器，这些守护程序可以与多个管理角色和工作角色一起工作。集群中的每个成员都是Docker守护程序，所有守护程序都使用Docker API进行通信。服务允许您定义所需的状态，例如在任何给定时间必须可用的服务副本数。默认情况下，该服务在所有工作节点之间是负载平衡的。对于消费者而言，Docker服务似乎是一个单独的应用程序。 Docker Engine在Docker 1.12及更高版本中支持集群模式。


## 九、底层实现技术

Docker用Go编程语言来编写的，并利用Linux内核的多个功能来提供出其功能。

### Namespaces

Docker使用一种称为名称空间的技术来提供称为容器的隔离工作区。运行容器时，Docker会为该容器创建一组名称空间。

这些名称空间提供了一隔离层。容器的每个方面都在单独的名称空间中运行，并且其访问仅限于该名称空间。

Docker使用以下名称空间：

* `pid` 名称空间：进程隔离(PID: Process ID)。
* `net` 名称空间：管理网络接口(NET: Networking)。
* `ipc` 名称空间：管理进程间通信资源的访问 (IPC: InterProcess Communication)。
* `mnt` 名称空间：管理文件系统挂载点(MNT: Mount)。
* `uts` 名称空间：隔离内核和版本标识符 (UTS: Unix Timesharing System)。


### Control groups

在Linux上的Docker还依赖于另一种被称为控制组（cgroups）的技术。 cgroup将应用程序限制为一组特定的资源。cgroups允许Docker Engine将可用的硬件资源共享给容器，并有选择地实施限制和约束。例如，可以限制特定容器可用的内存大小。

### Union file systems

Union file systems或UnionFS是通过创建图层进行操作的文件系统，使其非常轻便且快捷。 Docker Engine使用UnionFS为容器提供构建模块。 Docker Engine可以使用多个UnionFS变体，包括AUFS，btrfs，vfs和DeviceMapper。

### Container format

Docker Engine将namespaces，cgroups和UnionFS组合到一个称为容器格式的包装器中。默认容器格式为 `libcontainer` 。将来，Docker可能会通过与BSD Jails或Solaris Zones等技术集成来支持其他容器格式。
