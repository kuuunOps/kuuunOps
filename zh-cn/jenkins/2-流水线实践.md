# 流水线实践

## 集成Maven

1. 安装maven

```shell
cat >/etc/profile.d/m2.sh <<EOF
export M2_HOME=/usr/local/apache-maven-3.8.1/
export PATH=\$PATH:\$M2_HOME/bin
EOF
source /etc/profile
mvn -version
```

2. 配置jenkins

![maven](../../_media/maven.png ':size=80%')

3. Jenkinsfile使用

```groovy
pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Build"){
            steps{
                script{
                    MAVEN_HOME = tool "M2"
                    sh "${MAVEN_HOME}/bin/mvn -version"
                }
            }
        }
    }
}
```

maven常用命令

```shell
# 清理构建目录
mvn clean
# 打包
mvn package
# 打包部署
mvn clean install
# 单元测试
mvn test
```

4. 将构建命令使用选项参数传给pipeline使用（可选）

```groovy
#!/usr/bin/env groovy

String buildShell = "${env.buildShell}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Build"){
            steps{
                script{
                    MAVEN_HOME = tool "M2"
                    sh "${MAVEN_HOME}/bin/mvn ${buildShell}"
                }
            }
        }
    }
}
```

---

## 集成ant

1. 安装ant

```shell
cat >/etc/profile.d/ant.sh <<EOF
export ANT_HOME=/usr/local/apache-ant-1.10.10/
export PATH=\$PATH:\$ANT_HOME/bin
EOF
source /etc/profile
ant -version
```
2. 配置jenkins

![ant](../../_media/ant.png ':size=80%')

3. Jenkinsfile使用

```groovy
#!/usr/bin/env groovy

String buildShell = "${env.buildShell}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Maven Build"){
            steps{
                script{
                    MAVEN_HOME = tool "M2"
                    sh "${MAVEN_HOME}/bin/mvn ${buildShell}"
                }
            }
        }
        stage("Ant Build"){
            steps{
                script{
                    ANT_HOME = tool "ANT"
                    sh "${ANT_HOME}/bin/ant ${buildShell}"
                }
            }
        }
    }
}
```

---

## 集成Gradle

1. 安装gradle

```shell
cat >/etc/profile.d/gradle.sh <<EOF
export GRADLE_HOME=/usr/local/gradle-7.0/
export PATH=\$PATH:\$GRADLE_HOME/bin
EOF
source /etc/profile
gradle -version
```
2. 配置jenkins

![gradle](../../_media/gradle.png ':size=80%')

3. Jenkinsfile使用

```groovy
#!/usr/bin/env groovy

String buildShell = "${env.buildShell}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Maven Build"){
            steps{
                script{
                    MAVEN_HOME = tool "M2"
                    try{
                        sh "${MAVEN_HOME}/bin/mvn ${buildShell}"
                    }catch(e){
                        println(e)
                    }
                }
            }
        }
        stage("Ant Build"){
            steps{
                script{
                    ANT_HOME = tool "ANT"
                    try{
                        sh "${ANT_HOME}/bin/ant ${buildShell}"
                    }catch(e){
                        println(e)
                    }
                }
            }
        }
        stage("Gradle Build"){
            steps{
                script{
                    GRADLE_HOME = tool "GRADLE"
                    sh "${GRADLE_HOME}/bin/gradle ${buildShell}"
                }
            }
        }
    }
}

```
---
## 集成npm

1. 安装node

```shell
cat >/etc/profile.d/node.sh <<EOF
export NODE_HOME=/usr/local/node-v14.16.1-linux-x64
export PATH=\$PATH:\$NODE_HOME/bin
EOF
source /etc/profile
node -v
npm -version
```
2. 配置jenkins

![node](../../_media/nodejs.png ':size=80%')

3. Jenkinsfile使用

```groovy
#!/usr/bin/env groovy

String buildShell = "${env.buildShell}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Maven Build"){
            steps{
                script{
                    MAVEN_HOME = tool "M2"
                    //增加异常处理
                    try{
                        sh "${MAVEN_HOME}/bin/mvn ${buildShell}"
                    }catch(e){
                        println(e)
                    }
                }
            }
        }
        stage("Ant Build"){
            steps{
                script{
                    ANT_HOME = tool "ANT"
                    try{
                        sh "${ANT_HOME}/bin/ant ${buildShell}"
                    }catch(e){
                        println(e)
                    }
                }
            }
        }
        stage("Gradle Build"){
            steps{
                script{
                    GRADLE_HOME = tool "GRADLE"
                    sh "${GRADLE_HOME}/bin/gradle ${buildShell}"
                }
            }
        }
        stage("Npm Build"){
            steps{
                script{
                    NODE_HOME = tool "NODE"
                    try{
                        sh """
                            ${NODE_HOME}/bin/node -v
                            ${NODE_HOME}/bin/npm ${buildShell}
                        """
                    }catch(hudson.AbortException e){
                        println(e)
                        sh """
                            PATH=$PATH:${NODE_HOME}/bin
                            ${NODE_HOME}/bin/node -v
                            ${NODE_HOME}/bin/npm ${buildShell}
                        """
                    }
                }
            }
        }
    }
}
```

---

## 共享库封装构建工具

1. 创建库文件

```groovy
package org.devops

//构建
def build(btype,bshell){
    def buildTools = ["mvn":"M2","ant":"ANT","gradle":"GRADLE","npm":"NODE"]

    buildHome = tool buildTools[btype]
    if ("${btype}" == "npm"){
        sh """
            PATH=$PATH:${buildHome}/bin
            ${buildHome}/bin/${btype} ${bshell}
        """
    } else {
        sh "${buildHome}/bin/${btype} ${bshell}"
    }
}
```

2. 配置jenkins

![buildtype](../../_media/buildtype.png ':size=80%')

![buildshell](../../_media/buildshell.png ':size=80%')

3. 修改Jenkinsfile

```groovy
#!/usr/bin/env groovy
@Library("jenkinslibrary") _

def build = new org.devops.Build()

String buildType = "${env.buildType}"
String buildShell = "${env.buildShell}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Maven Build"){
            steps{
                script{
                    build.build(buildType,buildShell)
                }
            }
        }
    }
}
```
---
## 集成saltstack

1. 安装saltstack

- 配置yum

```shell
sudo rpm --import https://repo.saltproject.io/py3/redhat/7/x86_64/latest/SALTSTACK-GPG-KEY.pub
curl -fsSL https://repo.saltproject.io/py3/redhat/7/x86_64/latest.repo | sudo tee /etc/yum.repos.d/salt.repo
```
- 安装

```
sudo yum install salt-master
sudo yum install salt-minion
sudo yum install salt-ssh
sudo yum install salt-syndic
sudo yum install salt-cloud
sudo yum install salt-api
```

2. 编写jenkinslibrary

```groovy
/*
src/org/devops/Deploy.groovy
*/
package org.devops

def saltDeploy(hosts,command){
    sh "salt -L ${hosts} ${command}"
}
```

3. Jenkinsfile使用

```groovy
#!/usr/bin/env groovy
@Library("jenkinslibrary") _

def build = new org.devops.Build()
def deploy = new org.devops.Deploy()

String buildType = "${env.buildType}"
String buildShell = "${env.buildShell}"
// 新增字符串参数
String deployHosts = "${env.deployHosts}"

pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Build"){
            steps{
                script{
                    build.build(buildType,buildShell)
                }
            }
        }
        stage("Salt Deploy"){
            steps{
                script{
                    deploy.saltDeploy("${deployHosts}","test.ping")
                }
            }
        }
    }
}
```
---

## 集成ansible

1. 安装ansible

```shell
yum install epel-release -y
yum install ansible -y
```

2. 编写jenkinslibrary

```groovy
/*
src/org/devops/Deploy.groovy
*/
package org.devops

def saltDeploy(hosts,command){
    sh "salt -L ${hosts} ${command}"
}

def ansibleDeploy(hosts,command,options=""){
    if("${options}"== ""){
        sh "ansible ${hosts} -m ${command}"
    }else{
        sh "ansible ${hosts} -m ${command} -a ${options}"
    }
}
```

3. 编写Jenkinsfile

```groovy
#!/usr/bin/env groovy
@Library("jenkinslibrary") _

def build = new org.devops.Build()
def deploy = new org.devops.Deploy()

String buildType = "${env.buildType}"
String buildShell = "${env.buildShell}"
String deployHosts = "${env.deployHosts}"


pipeline{
    agent { node { label 'master'}}
    stages{
        stage("Build"){
            steps{
                script{
                    build.build(buildType,buildShell)
                }
            }
        }
        stage("Salt Deploy"){
            when {
                environment name: 'deployTools', value: 'salt'
            }
            steps{
                script{
                    deploy.saltDeploy("${deployHosts}","test.ping")
                }
            }
        }
        stage("Ansible Deploy"){
            when{
                environment name: 'deployTools',value: "ansible"
            }
            steps{
                script{
                    deploy.ansibleDeploy("${deployHosts}","ping")
                }
            }
        }
    }
}
```
---

## LDAP/AD集成

0. 修改安全配置

![secret](../../_media/anybody.png ':size=80%')

2. 安装`LDAP`/`Active Directory`

3. 配置jenkins

